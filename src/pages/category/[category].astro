---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  const categories = [...new Set(allPosts.flatMap((post) => post.data.categories ?? []))];

  return categories.map((category) => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const filteredPosts = (await getCollection(
  'posts',
  ({ data }) => !!category && data.categories?.includes(category),
))
  .sort(
    (a, b) =>
      b.data.pubDate.valueOf() -
      a.data.pubDate.valueOf(),
  );

---

<BaseLayout>
  <section class="mx-auto max-w-[750px] px-6 pt-16 pb-20">
    <h1 class="mb-3 text-5xl font-bold leading-tight md:text-6xl">Category</h1>
    <p class="mb-10 text-sm text-gray-500">
      Showing posts tagged <span class="font-medium text-gray-900">#{category}</span>
    </p>
    <div class="space-y-6">
      {filteredPosts.map((post) => (
        <PostCard
          url={`/${post.id}/`}
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          categories={post.data.categories}
          heroImage={post.data.heroImage}
        />
      ))}
    </div>
  </section>
</BaseLayout>
